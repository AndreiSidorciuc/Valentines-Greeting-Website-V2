// –ü–µ—Ä–µ–∫–ª–∞–¥–∏
const translations = {
  uk: {
    title: "–ó –î–Ω–µ–º –ó–∞–∫–æ—Ö–∞–Ω–∏—Ö ‚ù§Ô∏è",
    subtitle: "–î–ª—è –Ω–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–æ—ó –ª—é–¥–∏–Ω–∏ –≤ –º–æ—î–º—É –∂–∏—Ç—Ç—ñ",
    loveBtn: "–ù–∞—Ç–∏—Å–Ω–∏, —è–∫—â–æ –∫–æ—Ö–∞—î—à üíï",
    loveBtnBlocked: "–ü–æ–≤–µ—Ä–Ω–∏—Å—å —á–µ—Ä–µ–∑ 24 –≥–æ–¥–∏–Ω–∏ üíî",
    runawayBtn: "–ù–µ –∫–æ—Ö–∞—é",
    message1:
      "–ö–æ—Ö–∞–Ω–Ω—è ‚Äî —Ü–µ –∫–æ–ª–∏ –∫–æ–∂–µ–Ω –¥–µ–Ω—å –∑ —Ç–æ–±–æ—é —Å—Ç–∞—î —Å–≤—è—Ç–æ–º.<br />–î—è–∫—É—é –∑–∞ —Ç–≤–æ—é —É—Å–º—ñ—à–∫—É, —Ç–µ–ø–ª–æ —ñ –ø—ñ–¥—Ç—Ä–∏–º–∫—É.<br />–Ø –±–µ–∑–º–µ–∂–Ω–æ —â–∞—Å–ª–∏–≤–∏–π(–∞), —â–æ —Ç–∏ —î –≤ –º–æ—î–º—É –∂–∏—Ç—Ç—ñ.",
    message2:
      "–ù–µ—Ö–∞–π —Ü–µ–π –î–µ–Ω—å –ó–∞–∫–æ—Ö–∞–Ω–∏—Ö —Å—Ç–∞–Ω–µ —â–µ –æ–¥–Ω–∏–º –∫—Ä–∞—Å–∏–≤–∏–º —Å–ø–æ–≥–∞–¥–æ–º –¥–ª—è –Ω–∞—Å üíï",
    footer: "–ó –ª—é–±–æ–≤'—é üíå | 14 –ª—é—Ç–æ–≥–æ",
    slides: [
      "–¢–∏ - –º–æ—î —Å–æ–Ω—Ü–µ —É –ø–æ—Ö–º—É—Ä–∏–π –¥–µ–Ω—å ‚òÄÔ∏è",
      "–ö–æ–∂–Ω–∞ –º–∏—Ç—å –∑ —Ç–æ–±–æ—é - —Ü–µ –º–∞–≥—ñ—è ‚ú®",
      "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —è—Å–∫—Ä–∞–≤—ñ—à–∏–º üåà",
      "–ó —Ç–æ–±–æ—é —è –ø–æ-—Å–ø—Ä–∞–≤–∂–Ω—å–æ–º—É —â–∞—Å–ª–∏–≤–∏–π(–∞) üíï",
      "–î—è–∫—É—é, —â–æ —Ç–∏ —î –≤ –º–æ—î–º—É –∂–∏—Ç—Ç—ñ! ‚ù§Ô∏è",
      "–¢–≤–æ—è —É—Å–º—ñ—à–∫–∞ - –Ω–∞–π–∫—Ä–∞—â–µ, —â–æ —è –±–∞—á—É –∫–æ–∂–µ–Ω –¥–µ–Ω—å üòä",
      "–ü–æ—Ä—É—á –∑ —Ç–æ–±–æ—é —è –≤–¥–æ–º–∞, –¥–µ –± –º–∏ –Ω–µ –±—É–ª–∏ üè°",
      "–ó —Ç–æ–±–æ—é –Ω–∞–≤—ñ—Ç—å –∑–≤–∏—á–∞–π–Ω—ñ –º–∏—Ç—ñ —Å—Ç–∞—é—Ç—å –æ—Å–æ–±–ª–∏–≤–∏–º–∏ ‚ú®",
    ],
    funnyTexts: [
      "–ì–µ–π, –Ω–µ –ª–æ–≤–∏ –º–µ–Ω–µ! üèÉ",
      "–¢–∏ —Å–µ—Ä–π–æ–∑–Ω–æ? üòÖ",
      "–ù—É —Ç–∏ –π –Ω–∞–ø–æ–ª–µ–≥–ª–∏–≤–∞! üòÑ",
      "–°—Ç—ñ–π, —Å—Ç—ñ–π! ü§™",
      "–Ø —à–≤–∏–¥—à–∏–π! ‚ö°",
      "–ú–∞–π–∂–µ –∑–ª–æ–≤–∏–ª–∞! üòú",
      "–©–µ —Ç—Ä–æ—Ö–∏ —Å–ø—Ä–æ–±—É–π! üí®",
      "–û—Å—Ç–∞–Ω–Ω—ñ–π —Ä–∞–∑ –≤—Ç—ñ–∫–∞—é! üôà",
      "–õ–∞–¥–Ω–æ-–ª–∞–¥–Ω–æ... üò≥",
      "–ó–¥–∞—é—Å—è! üè≥Ô∏è",
      "–¢–æ—á–Ω–æ –Ω–µ –∫–æ—Ö–∞—î—à?",
    ],
    finalBtn: "–¢–æ—á–Ω–æ –Ω–µ –∫–æ—Ö–∞—î—à?",
    sadText1: "–®–∫–æ–¥–∞...",
    sadText2: "–¢–µ–ø–µ—Ä —Ç–∏ —Ç–∞–∫ —ñ –Ω–µ –¥—ñ–∑–Ω–∞—î—à—Å—è,",
    sadText3: '—â–æ –±—É–ª–æ –±, –∫–æ–ª–∏ –± —Ç–∏ –Ω–∞—Ç–∏—Å–Ω—É–ª–∞ –Ω–∞ "–ö–æ—Ö–∞—é"',
    closeBtn: "–ó–∞–∫—Ä–∏—Ç–∏",
    blockedTooltip: "–¢–∏ –æ–±—Ä–∞–ª–∞ –Ω–µ –∫–æ—Ö–∞—Ç–∏... –ü–æ–≤–µ—Ä–Ω–∏—Å—å —á–µ—Ä–µ–∑ ",
  },
  de: {
    title: "Alles Gute zum Valentinstag ‚ù§Ô∏è",
    subtitle: "F√ºr die wichtigste Person in meinem Leben",
    loveBtn: "Dr√ºck, wenn du liebst üíï",
    loveBtnBlocked: "Komm in 24 Stunden zur√ºck üíî",
    runawayBtn: "Ich liebe nicht",
    message1:
      "Liebe ist, wenn jeder Tag mit dir zum Fest wird.<br />Danke f√ºr dein L√§cheln, deine W√§rme und Unterst√ºtzung.<br />Ich bin unendlich gl√ºcklich, dass du in meinem Leben bist.",
    message2:
      "M√∂ge dieser Valentinstag eine weitere sch√∂ne Erinnerung f√ºr uns werden üíï",
    footer: "Mit Liebe üíå | 14. Februar",
    slides: [
      "Du bist meine Sonne an tr√ºben Tagen ‚òÄÔ∏è",
      "Jeder Moment mit dir ist Magie ‚ú®",
      "Du machst mein Leben bunter üåà",
      "Mit dir bin ich wirklich gl√ºcklich üíï",
      "Danke, dass es dich in meinem Leben gibt! ‚ù§Ô∏è",
      "Dein L√§cheln ist das Sch√∂nste, was ich jeden Tag sehe üòä",
      "Bei dir bin ich zuhause, egal wo wir sind üè°",
      "Mit dir werden selbst gew√∂hnliche Momente besonders ‚ú®",
    ],
    funnyTexts: [
      "Hey, fang mich nicht! üèÉ",
      "Ist das dein Ernst? üòÖ",
      "Du bist ja hartn√§ckig! üòÑ",
      "Halt, halt! ü§™",
      "Ich bin schneller! ‚ö°",
      "Fast erwischt! üòú",
      "Versuch's noch mal! üí®",
      "Das letzte Mal, dass ich weglaufe! üôà",
      "Na gut... üò≥",
      "Ich gebe auf! üè≥Ô∏è",
      "Du liebst mich wirklich nicht?",
    ],
    finalBtn: "Du liebst mich wirklich nicht?",
    sadText1: "Schade...",
    sadText2: "Jetzt wirst du nie erfahren,",
    sadText3: 'was passiert w√§re, wenn du auf "Ich liebe" gedr√ºckt h√§ttest',
    closeBtn: "Schlie√üen",
    blockedTooltip: "Du hast dich gegen die Liebe entschieden... Komm in ",
  },
  en: {
    title: "Happy Valentine's Day ‚ù§Ô∏è",
    subtitle: "For the most important person in my life",
    loveBtn: "Press if you love üíï",
    loveBtnBlocked: "Come back in 24 hours üíî",
    runawayBtn: "I don't love",
    message1:
      "Love is when every day with you becomes a celebration.<br />Thank you for your smile, warmth and support.<br />I'm infinitely happy that you're in my life.",
    message2:
      "May this Valentine's Day become another beautiful memory for us üíï",
    footer: "With love üíå | February 14th",
    slides: [
      "You are my sunshine on a cloudy day ‚òÄÔ∏è",
      "Every moment with you is magic ‚ú®",
      "You make my life brighter üåà",
      "With you I'm truly happy üíï",
      "Thank you for being in my life! ‚ù§Ô∏è",
      "Your smile is the best thing I see every day üòä",
      "With you I'm home, wherever we are üè°",
      "With you, even ordinary moments feel special ‚ú®",
    ],
    funnyTexts: [
      "Hey, don't catch me! üèÉ",
      "Are you serious? üòÖ",
      "You're so persistent! üòÑ",
      "Stop, stop! ü§™",
      "I'm faster! ‚ö°",
      "Almost caught me! üòú",
      "Try a bit more! üí®",
      "Last time I'm running! üôà",
      "Okay, okay... üò≥",
      "I surrender! üè≥Ô∏è",
      "You really don't love me?",
    ],
    finalBtn: "You really don't love me?",
    sadText1: "Too bad...",
    sadText2: "Now you'll never know,",
    sadText3: 'what would have happened if you pressed "I love"',
    closeBtn: "Close",
    blockedTooltip: "You chose not to love... Come back in ",
  },
};

// ================== –ó–ú–Ü–ù–ù–Ü ==================
let currentLang = "uk";
let currentSlideIndex = 0;
let autoSlideInterval = null;
let loveInterval = null;
let escapeCount = 0;
let countdownInterval = null;

const slides = document.querySelectorAll(".slide");
const totalSlides = slides.length;
document.getElementById("totalSlides").textContent = totalSlides;

const runawayBtn = document.getElementById("runaway-btn");
const messageBlock = document.querySelector(".message");
const footerBlock = document.querySelector("footer");
const langSelector = document.querySelector(".language-selector");

const isTouch = "ontouchstart" in window || navigator.maxTouchPoints > 0;

// ================== –ë–õ–û–ö–£–í–ê–ù–ù–Ø –ö–ù–û–ü–ö–ò ==================
const BLOCK_KEY = "loveBtnBlockedUntil";
const BLOCK_DURATION = 1 * 60 * 60 * 1000;

function blockLoveButton() {
  localStorage.setItem(BLOCK_KEY, Date.now() + BLOCK_DURATION);
  applyLoveButtonBlock();
}

function applyLoveButtonBlock() {
  const blockedUntil = +localStorage.getItem(BLOCK_KEY) || 0;
  const loveBtn = document.querySelector(".love-btn");

  if (Date.now() < blockedUntil) {
    loveBtn.disabled = true;
    loveBtn.style.opacity = "0.6";
    loveBtn.style.cursor = "not-allowed";
    loveBtn.onclick = null;
    startCountdown(blockedUntil);
  } else {
    localStorage.removeItem(BLOCK_KEY);
    unblockLoveButton();
  }
}

function unblockLoveButton() {
  const loveBtn = document.querySelector(".love-btn");
  loveBtn.disabled = false;
  loveBtn.style.opacity = "1";
  loveBtn.style.cursor = "pointer";
  loveBtn.onclick = startLove;
  document.getElementById("love-btn-text").innerHTML =
    translations[currentLang].loveBtn;
  clearInterval(countdownInterval);
  countdownInterval = null;
}

function startCountdown(blockedUntil) {
  clearInterval(countdownInterval);

  function update() {
    const remaining = blockedUntil - Date.now();
    if (remaining <= 0) {
      unblockLoveButton();
      return;
    }
    const h = String(Math.floor(remaining / 3600000)).padStart(2, "0");
    const m = String(Math.floor((remaining % 3600000) / 60000)).padStart(
      2,
      "0",
    );
    const s = String(Math.floor((remaining % 60000) / 1000)).padStart(2, "0");
    document.getElementById("love-btn-text").innerHTML = `‚è≥ ${h}:${m}:${s}`;
  }

  update();
  countdownInterval = setInterval(update, 1000);
}

// ================== –ó–ú–Ü–ù–ê –ú–û–í–ò ==================
function changeLanguage(lang, event) {
  // –î–æ–¥–∞–ª–∏ event
  currentLang = lang;

  // –¢–µ–ø–µ—Ä event.target –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
  if (event) {
    document
      .querySelectorAll(".lang-btn")
      .forEach((b) => b.classList.remove("active"));
    event.target.classList.add("active");
  }

  const t = translations[lang];
  document.getElementById("main-title").innerHTML = t.title;
  document.getElementById("subtitle").innerHTML = t.subtitle;
  document.getElementById("message-text-1").innerHTML = t.message1;
  document.getElementById("message-text-2").innerHTML = t.message2;
  document.getElementById("footer-text").innerHTML = t.footer;
  document.getElementById("sad-text-1").innerHTML = t.sadText1;
  document.getElementById("sad-text-2").innerHTML = t.sadText2;
  document.getElementById("sad-text-3").innerHTML = t.sadText3;
  document.getElementById("close-btn-text").innerHTML = t.closeBtn;

  document.querySelectorAll(".slide-text").forEach((el, i) => {
    el.innerHTML = t.slides[i];
  });

  const blockedUntil = +localStorage.getItem(BLOCK_KEY) || 0;
  if (Date.now() >= blockedUntil) {
    document.getElementById("love-btn-text").innerHTML = t.loveBtn;
  }

  if (escapeCount === 0) {
    document.getElementById("runaway-btn-text").innerHTML = t.runawayBtn;
  } else if (escapeCount >= t.funnyTexts.length) {
    runawayBtn.textContent = t.finalBtn;
  }
}

// ================== –°–ï–†–¶–Ø ==================
function createHeart(inModal = false) {
  const heart = document.createElement("div");
  heart.className = inModal ? "modal-heart" : "falling-heart";
  heart.innerText = "üíó";
  heart.style.left = Math.random() * 100 + "vw";
  heart.style.animationDuration = 3 + Math.random() * 3 + "s";
  document.body.appendChild(heart);
  setTimeout(() => heart.remove(), 6000);
}

// ================== –°–ö–†–û–õ ==================
function lockScroll() {
  document.body.style.position = "fixed";
  document.body.style.width = "100%";
}

function unlockScroll() {
  document.body.style.position = "";
  document.body.style.width = "";
}

// ================== –ú–û–î–ê–õ–ö–ê –ó –§–û–¢–û ==================
function startLove() {
  const blockedUntil = +localStorage.getItem(BLOCK_KEY) || 0;
  if (Date.now() < blockedUntil) return;

  const modal = document.getElementById("photoModal");
  const music = document.getElementById("music");

  modal.style.display = "block";
  lockScroll();

  currentSlideIndex = 0;
  showSlide(0);
  startAutoSlide();

  // –ó–∞–ø—É—Å–∫–∞—î–º–æ –º—É–∑–∏–∫—É
  music.muted = true;
  music
    .play()
    .then(() => {
      music.muted = false;
    })
    .catch(() => {});

  // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–µ—Ä—Ü—è
  if (!loveInterval) {
    loveInterval = setInterval(() => createHeart(true), 300);
  }
}

function closeModal() {
  const modal = document.getElementById("photoModal");
  const music = document.getElementById("music");

  // –•–æ–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É
  modal.style.display = "none";

  // –†–æ–∑–±–ª–æ–∫–æ–≤—É—î–º–æ —Å–∫—Ä–æ–ª
  unlockScroll();

  // –ó—É–ø–∏–Ω—è—î–º–æ —Å–ª–∞–π–¥–∏
  stopAutoSlide();

  // –ó—É–ø–∏–Ω—è—î–º–æ –º—É–∑–∏–∫—É
  music.pause();
  music.currentTime = 0;

  // –ó—É–ø–∏–Ω—è—î–º–æ —Å–µ—Ä—Ü—è
  if (loveInterval) {
    clearInterval(loveInterval);
    loveInterval = null;
  }
}

function closeSadModal() {
  document.getElementById("sadModal").style.display = "none";
  unlockScroll();
}

// ================== –°–õ–ê–ô–î–ò ==================
function showSlide(index) {
  slides.forEach((s) => s.classList.remove("active"));
  currentSlideIndex = (index + slides.length) % slides.length;
  slides[currentSlideIndex].classList.add("active");
  document.getElementById("currentSlide").textContent = currentSlideIndex + 1;
}

function changeSlide(dir) {
  showSlide(currentSlideIndex + dir);
  if (autoSlideInterval) startAutoSlide();
}

function startAutoSlide() {
  stopAutoSlide();
  autoSlideInterval = setInterval(() => changeSlide(1), 3000);
}

function stopAutoSlide() {
  clearInterval(autoSlideInterval);
  autoSlideInterval = null;
}

// ================== –°–í–ê–ô–ü ==================
let touchStartX = 0;

const modalEl = document.getElementById("photoModal");

modalEl.addEventListener(
  "touchstart",
  (e) => {
    touchStartX = e.changedTouches[0].screenX;
  },
  { passive: true },
);

modalEl.addEventListener(
  "touchend",
  (e) => {
    const delta = e.changedTouches[0].screenX - touchStartX;
    if (Math.abs(delta) > 60) changeSlide(delta < 0 ? 1 : -1);
  },
  { passive: true },
);

modalEl.addEventListener("touchmove", (e) => e.preventDefault(), {
  passive: false,
});

// ================== –ö–õ–ê–í–Ü–ê–¢–£–†–ê ==================
document.addEventListener("keydown", (e) => {
  const modal = document.getElementById("photoModal");
  if (modal.style.display === "block") {
    if (e.key === "ArrowLeft") changeSlide(-1);
    if (e.key === "ArrowRight") changeSlide(1);
    if (e.key === "Escape") closeModal();
  }
});

// ================== –ö–õ–Ü–ö –ü–û –§–û–ù–£ ==================
window.addEventListener("click", (e) => {
  const modal = document.getElementById("photoModal");
  const sadModal = document.getElementById("sadModal");
  if (e.target === modal) closeModal();
  if (e.target === sadModal) closeSadModal();
});

// ================== RUNAWAY –ö–ù–û–ü–ö–ê ==================
function moveRunawayButton() {
  const btnW = runawayBtn.offsetWidth;
  const btnH = runawayBtn.offsetHeight;
  const pad = 16;
  const scrollY = window.scrollY;
  const msgR = messageBlock.getBoundingClientRect();
  const ftrR = footerBlock.getBoundingClientRect();
  const langR = langSelector.getBoundingClientRect();

  let x,
    y,
    tries = 0;

  do {
    x = Math.random() * (window.innerWidth - btnW - pad * 2) + pad;
    y = Math.random() * (window.innerHeight - btnH - pad * 2) + pad + scrollY;
    tries++;

    const hitMsg = !(
      x + btnW < msgR.left ||
      x > msgR.right ||
      y + btnH < msgR.top + scrollY ||
      y > msgR.bottom + scrollY
    );
    const hitFtr = !(
      x + btnW < ftrR.left ||
      x > ftrR.right ||
      y + btnH < ftrR.top + scrollY ||
      y > ftrR.bottom + scrollY
    );
    const hitLang = !(
      x + btnW < langR.left ||
      x > langR.right ||
      y + btnH < langR.top + scrollY ||
      y > langR.bottom + scrollY
    );

    if (!hitMsg && !hitFtr && !hitLang) break;
  } while (tries < 100);

  runawayBtn.style.position = "absolute";
  runawayBtn.style.left = `${x}px`;
  runawayBtn.style.top = `${y}px`;

  if (navigator.vibrate) navigator.vibrate(20);
}

function handleRunaway(e) {
  if (e) e.preventDefault();

  const texts = translations[currentLang].funnyTexts;

  if (escapeCount < texts.length) {
    // –©–µ –≤—Ç—ñ–∫–∞—î
    runawayBtn.innerHTML = `<span id="runaway-btn-text">${texts[escapeCount]}</span>`;
    setTimeout(moveRunawayButton, isTouch ? 300 : 150);
    escapeCount++;
  } else {
    // –í—Å—ñ —Ç–µ–∫—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ñ - –ø–æ–∫–∞–∑—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç
    runawayBtn.textContent = translations[currentLang].finalBtn;
    runawayBtn.style.cursor = "pointer";
    runawayBtn.style.background = "#888";
  }
}

function openSadModal() {
  document.getElementById("sadModal").style.display = "block";
  lockScroll();
  blockLoveButton();
}

if (isTouch) {
  // –ú–æ–±—ñ–ª—å–Ω–∏–π - –æ–¥–∏–Ω –æ–±—Ä–æ–±–Ω–∏–∫ touchstart
  runawayBtn.addEventListener(
    "touchstart",
    (e) => {
      e.preventDefault();

      if (escapeCount >= translations[currentLang].funnyTexts.length) {
        openSadModal();
      } else {
        handleRunaway(e);
      }
    },
    { passive: false },
  );
} else {
  // –î–µ—Å–∫—Ç–æ–ø - mouseenter –¥–ª—è –≤—Ç–µ—á—ñ, click –¥–ª—è –º–æ–¥–∞–ª–∫–∏
  runawayBtn.addEventListener("mouseenter", (e) => {
    if (escapeCount < translations[currentLang].funnyTexts.length) {
      handleRunaway(e);
    }
  });

  runawayBtn.addEventListener("click", () => {
    if (escapeCount >= translations[currentLang].funnyTexts.length) {
      openSadModal();
    }
  });
}

// ================== –û–†–Ü–Ñ–ù–¢–ê–¶–Ü–Ø ==================
window.addEventListener("orientationchange", () => {
  runawayBtn.style.left = "50%";
  runawayBtn.style.top = "80%";
  runawayBtn.style.transform = "translateX(-50%)";
});

// ================== INIT ==================
window.addEventListener("load", () => {
  applyLoveButtonBlock();
  document.querySelectorAll(".slide-text").forEach((el, i) => {
    el.innerHTML = translations[currentLang].slides[i];
  });
});
